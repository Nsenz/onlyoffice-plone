<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="onlyoffice.connector">

<!--
 *
 * (c) Copyright Ascensio System SIA 2021
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 -->

<metal:block fill-slot="content-core">
    <div id="onlyofficeEditor"></div>
    <div id="onlyofficeError" i18n:translate="" style="display:none;">DocumentServer not accessible.</div>
    <div id="onlyofficeErrorVersion" i18n:translate="" style="display:none;">Please update ONLYOFFICE Docs to version 7.0 to work on fillable forms online.</div>

    <script type="text/javascript" src="${view/docUrl}/web-apps/apps/api/documents/api.js"></script>
    <script type="text/javascript" language="javascript">
        var docEditor;
        config = ${view/editorCfg}
        config.width = "100%";
        config.height = "600px";

        var saveAs = ${view/saveAs}

        var onRequestSaveAs = function (event) {
            var url = event.data.url;
            var fileType = event.data.fileType;

            var request = new XMLHttpRequest();
            request.open("POST", "${context/absolute_url}/onlyoffice-save-as", true);
            request.setRequestHeader("x-csrf-token", "${view/token}");
            request.send(JSON.stringify({
                url: url,
                fileType: fileType
            }));

            request.onreadystatechange = function() {
                if (request.readyState != 4) return;
                if (request.status == 200) {
                    var response = JSON.parse(request.response);
                    docEditor.showMessage(saveAs.messages.success + response.fileName);
                } else if (request.status == 403) {
                    docEditor.showMessage(saveAs.messages.errorNotAuthorized);
                } else {
                    docEditor.showMessage(saveAs.messages.errorUnknown);
                }
            }
        }

        config.events = {};

        if (saveAs.available) {
            config.events.onRequestSaveAs = onRequestSaveAs
        }

        if (typeof DocsAPI === "undefined") {
            document.getElementById("onlyofficeError").style.display = "block";
        } else if ((config.document.fileType === "docxf" || config.document.fileType === "oform")
            && DocsAPI.DocEditor.version().split(".")[0] < 7) {
            document.getElementById("onlyofficeErrorVersion").style.display = "block";
        } else {
            docEditor = new DocsAPI.DocEditor("onlyofficeEditor", config);
        }
    </script>
</metal:block>

</html>